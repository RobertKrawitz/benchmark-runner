apiVersion: ripsaw.cloudbulldozer.io/v1alpha1
kind: Benchmark
metadata:
  name: uperf-{{ kind }}
  namespace: {{ namespace }}
spec:
  system_metrics:
    collection: {{ system_metrics }}
    prom_url: "{{ prom_url }}"
    es_url: "{{ es_url }}"
    prom_token: "{{ prom_token }}"
    metrics_profile: "{{ metrics_profile }}"
    index_name: {{ sm_index_name }}
  elasticsearch:
    url: "{{ es_url }}"
    index_name: {{ es_index_name }}
  metadata:
    collection: true
  cleanup: false
  workload:
    name: uperf
    args:
      {%- if requests_cpu or requests_memory or limits_cpu or limits_memory %}
      client_resources:
        {%- if requests_cpu or requests_memory %}
        requests:
          {%- if requests_cpu %}
          cpu: {{ requests_cpu }}
          {%- endif %}
          {%- if requests_memory %}
          memory: {{ requests_memory }}
          {%- endif %}
        {%- endif %}
        {%- if limits_cpu or limits_memory %}
        limits:
          {%- if limits_cpu %}
          cpu: {{ limits_cpu }}
          {%- endif %}
          {%- if limits_memory %}
          memory: {{ limits_memory }}
          {%- endif %}
        {%- endif %}
      server_resources:
        {%- if requests_cpu or requests_memory %}
        requests:
          {%- if requests_cpu %}
          cpu: {{ requests_cpu }}
          {%- endif %}
          {%- if requests_memory %}
          memory: {{ requests_memory }}
          {%- endif %}
        {%- endif %}
        {%- if limits_cpu or limits_memory %}
        limits:
          {%- if limits_cpu %}
          cpu: {{ limits_cpu }}
          {%- endif %}
          {%- if limits_memory %}
          memory: {{ limits_memory }}
          {%- endif %}
        {%- endif %}
      {%- endif %}
      pin: {{ pin }}
      pin_server: "{{ pin_server }}"
      pin_client: "{{ pin_client }}"
      serviceip: {{ serviceip }}
      hostnetwork: {{ hostnetwork }}
      networkpolicy: {{ networkpolicy }}
      multus:
        enabled: {{ multus }}
      samples: {{ samples }}
      pair: {{ pair }}
      test_types:
        {%- for test_type in test_types %}
        - {{ test_type -}}
        {% endfor %}
      protos:
        {%- for proto in protos %}
        - {{ proto -}}
        {% endfor %}
      sizes:
        {%- for size in sizes %}
        - {{ size -}}
        {% endfor %}
      nthrs:
        {%- for nthr in nthrs %}
        - {{ nthr -}}
        {% endfor %}
      runtime: {{ runtime }}
      {%- if kind == 'kata' %}
      runtime_class: kata
      {%- endif %}
      kind: pod
